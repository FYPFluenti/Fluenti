<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Integration Test</title>
</head>
<body>
    <h1>Voice Integration Test</h1>
    <button id="recordBtn">Start Recording</button>
    <p id="status">Click to start recording</p>
    <div id="results"></div>

    <script>
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        
        const recordBtn = document.getElementById('recordBtn');
        const status = document.getElementById('status');
        const results = document.getElementById('results');
        
        recordBtn.addEventListener('click', async () => {
            if (!isRecording) {
                await startRecording();
            } else {
                await stopRecording();
            }
        });
        
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const mimeType = MediaRecorder.isTypeSupported('audio/wav') ? 'audio/wav' : 'audio/webm';
                mediaRecorder = new MediaRecorder(stream, { mimeType });
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    await sendToBackend(audioBlob);
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
                isRecording = true;
                recordBtn.textContent = 'Stop Recording';
                status.textContent = 'Recording... Speak now!';
            } catch (error) {
                console.error('Error starting recording:', error);
                status.textContent = 'Error: ' + error.message;
            }
        }
        
        async function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                isRecording = false;
                recordBtn.textContent = 'Start Recording';
                status.textContent = 'Processing...';
            }
        }
        
        async function sendToBackend(audioBlob) {
            try {
                const formData = new FormData();
                formData.append('mode', 'voice');
                formData.append('language', 'en');
                formData.append('audio', audioBlob, 'voice.wav');
                formData.append('history', JSON.stringify([]));
                
                const response = await fetch('http://localhost:3001/api/emotional-support', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        // Note: You'll need proper authentication for production
                        'Authorization': 'Bearer test-token'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    results.innerHTML = `
                        <h3>Results:</h3>
                        <p><strong>Transcription:</strong> ${data.transcription || 'N/A'}</p>
                        <p><strong>Emotion:</strong> ${data.emotion || 'N/A'}</p>
                        <p><strong>Response:</strong> ${data.response || 'N/A'}</p>
                    `;
                    status.textContent = 'Success! Check results below.';
                } else {
                    const errorData = await response.text();
                    status.textContent = `Error: ${response.status} - ${errorData}`;
                }
            } catch (error) {
                console.error('Error sending to backend:', error);
                status.textContent = 'Network error: ' + error.message;
            }
        }
    </script>
</body>
</html>
