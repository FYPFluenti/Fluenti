<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Simple MediaRecorder Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 500px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
            width: 100%;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .recording { background: #dc3545 !important; }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .info { background: #d1ecf1; color: #0c5460; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        #log {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Simple MediaRecorder Test</h1>
        
        <div id="status" class="status info">Ready to test</div>
        
        <button id="testBtn" onclick="testMediaRecorder()">Test MediaRecorder</button>
        <button onclick="clearLog()">Clear Log</button>
        
        <div id="log"></div>
    </div>

    <script>
        let mediaRecorder = null;
        let chunks = [];
        let stream = null;
        let isRecording = false;

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        async function testMediaRecorder() {
            const btn = document.getElementById('testBtn');
            
            if (!isRecording) {
                try {
                    log('üöÄ Starting MediaRecorder test...');
                    updateStatus('Starting recording...', 'info');

                    // Check MediaRecorder support
                    if (typeof MediaRecorder === 'undefined') {
                        log('‚ùå MediaRecorder not supported');
                        updateStatus('MediaRecorder not supported', 'error');
                        return;
                    }
                    log('‚úÖ MediaRecorder supported');

                    // Request microphone access
                    log('üé§ Requesting microphone access...');
                    stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            channelCount: 1,
                            sampleRate: 16000,
                            echoCancellation: true,
                            noiseSuppression: true
                        }
                    });
                    log('‚úÖ Microphone access granted');

                    // Find supported MIME type
                    const mimeTypes = [
                        'audio/webm;codecs=opus',
                        'audio/webm',
                        'audio/mp4',
                        'audio/wav'
                    ];
                    
                    let selectedMimeType = '';
                    for (const mimeType of mimeTypes) {
                        if (MediaRecorder.isTypeSupported(mimeType)) {
                            selectedMimeType = mimeType;
                            log(`‚úÖ Supported MIME type found: ${mimeType}`);
                            break;
                        }
                    }
                    
                    if (!selectedMimeType) {
                        log('‚ùå No supported MIME types found');
                        updateStatus('No supported audio formats', 'error');
                        return;
                    }

                    // Create MediaRecorder
                    mediaRecorder = new MediaRecorder(stream, {
                        mimeType: selectedMimeType
                    });
                    log(`üìπ MediaRecorder created with MIME type: ${selectedMimeType}`);

                    // Reset chunks
                    chunks = [];
                    log('üîÑ Chunks array reset');

                    // Set up event handlers
                    mediaRecorder.onstart = () => {
                        log('‚ñ∂Ô∏è MediaRecorder started');
                        isRecording = true;
                        btn.textContent = 'Stop Recording';
                        btn.classList.add('recording');
                        updateStatus('üî¥ Recording... speak now!', 'info');
                    };

                    mediaRecorder.ondataavailable = (event) => {
                        log(`üìä Data available: ${event.data.size} bytes`);
                        if (event.data.size > 0) {
                            chunks.push(event.data);
                            log(`üì¶ Added chunk, total chunks: ${chunks.length}`);
                        }
                    };

                    mediaRecorder.onstop = () => {
                        log(`‚èπÔ∏è MediaRecorder stopped, total chunks: ${chunks.length}`);
                        
                        const blob = new Blob(chunks, { type: selectedMimeType });
                        log(`üíæ Blob created: ${blob.size} bytes, type: ${blob.type}`);
                        
                        if (blob.size > 0) {
                            updateStatus(`‚úÖ Recording successful! ${blob.size} bytes`, 'success');
                        } else {
                            updateStatus('‚ö†Ô∏è Recording produced empty blob', 'error');
                        }
                        
                        // Clean up
                        if (stream) {
                            stream.getTracks().forEach(track => {
                                track.stop();
                                log(`üîá Stopped audio track: ${track.label}`);
                            });
                            stream = null;
                        }
                        
                        isRecording = false;
                        btn.textContent = 'Test MediaRecorder';
                        btn.classList.remove('recording');
                    };

                    mediaRecorder.onerror = (event) => {
                        log(`‚ùå MediaRecorder error: ${event.error}`);
                        updateStatus('Recording failed', 'error');
                        isRecording = false;
                        btn.textContent = 'Test MediaRecorder';
                        btn.classList.remove('recording');
                    };

                    // Start recording
                    log('üé¨ Starting MediaRecorder...');
                    mediaRecorder.start(500); // Collect data every 500ms
                    log('üìù MediaRecorder.start() called');

                } catch (error) {
                    log(`‚ùå Error: ${error.message}`);
                    updateStatus(`Error: ${error.message}`, 'error');
                }
                
            } else {
                // Stop recording
                log('‚èπÔ∏è Stop button clicked');
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    log('‚èπÔ∏è Calling mediaRecorder.stop()');
                    mediaRecorder.stop();
                } else {
                    log(`‚ùå MediaRecorder not in recording state: ${mediaRecorder ? mediaRecorder.state : 'null'}`);
                }
            }
        }

        // Initialize
        window.onload = function() {
            log('üèÅ Page loaded, ready for testing');
        };
    </script>
</body>
</html>
